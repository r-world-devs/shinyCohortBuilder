<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="shinyCohortBuilder">
<title>Implementing custom GUI filter layer • shinyCohortBuilder</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Implementing custom GUI filter layer">
<meta property="og:description" content="shinyCohortBuilder">
<meta property="og:image" content="https://github.com/r-world-devs/shinyCohortBuilder/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">shinyCohortBuilder</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9038</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/shinyCohortBuilder.html">
    <span class="fa fa fa fa-thumbs-o-up"></span>
     
    Get started
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">
    <span class="fa fa fa fa-file-code-o"></span>
     
    Functions
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--articles">
    <span class="fa fa fa fa-thumbs-o-up"></span>
     
    Articles
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--articles">
    <a class="dropdown-item" href="../articles/package-options.html">shinyCohortBuilder options</a>
    <a class="dropdown-item" href="../articles/updating-source.html">Updating Source in Shiny</a>
    <a class="dropdown-item" href="../articles/gui-filter-layer.html">Implementing custom GUI filter layer</a>
    <a class="dropdown-item" href="../articles/custom-gui-layer.html">Creating custom source extension</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">
    <span class="fa fa fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/r-world-devs/shinyCohortBuilder/issues">
    <span class="fa fa fa fa-ambulance"></span>
     
    Issues
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Implementing custom GUI filter layer</h1>
            
      
      
      <div class="d-none name"><code>gui-filter-layer.Rmd</code></div>
    </div>

    
    
<p>In this document you’ll learn how to write custom filter controller for the selected filter.</p>
<div class="section level2">
<h2 id="gui-filter-layer-as-a-s3-method">GUI Filter Layer as a S3 Method<a class="anchor" aria-label="anchor" href="#gui-filter-layer-as-a-s3-method"></a>
</h2>
<p>When working with <code>cohortBuilder</code> in order to configure filter you need to precise its type:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-world-devs/cohortBuilder/" class="external-link">cohortBuilder</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'cohortBuilder'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, step</span>
<span class="va">iris_source</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-world-devs.github.io/cohortBuilder/reference/set_source.html" class="external-link">set_source</a></span><span class="op">(</span><span class="fu"><a href="https://r-world-devs.github.io/cohortBuilder/reference/tblist.html" class="external-link">tblist</a></span><span class="op">(</span>iris <span class="op">=</span> <span class="va">iris</span><span class="op">)</span><span class="op">)</span>
<span class="va">species_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-world-devs.github.io/cohortBuilder/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span>
  type <span class="op">=</span> <span class="st">"discrete"</span>, 
  id <span class="op">=</span> <span class="st">"species"</span>,
  dataset <span class="op">=</span> <span class="st">"iris"</span>,
  variable <span class="op">=</span> <span class="st">"Species"</span>,
  value <span class="op">=</span> <span class="st">"setosa"</span>
<span class="op">)</span></code></pre></div>
<p>Such filter evaluated on Source (the operation happens within the Cohort) becomes an object of class equal to the filter type:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">evaled_filter</span> <span class="op">&lt;-</span> <span class="fu">species_filter</span><span class="op">(</span><span class="va">iris_source</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">evaled_filter</span><span class="op">)</span>
<span class="co">#&gt; [1] "cb_filter" "discrete"</span></code></pre></div>
<p>For the further needs let’s highlight what methods and parameters are originally stored withing the evaluated filter object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">evaled_filter</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; List of 10</span>
<span class="co">#&gt;  $ id          : chr "species"</span>
<span class="co">#&gt;  $ type        : 'discrete' chr "discrete"</span>
<span class="co">#&gt;  $ name        : chr "species"</span>
<span class="co">#&gt;  $ input_param : chr "value"</span>
<span class="co">#&gt;  $ filter_data :function (data_object)  </span>
<span class="co">#&gt;  $ get_stats   :function (data_object, name)  </span>
<span class="co">#&gt;  $ plot_data   :function (data_object)  </span>
<span class="co">#&gt;  $ get_params  :function (name)  </span>
<span class="co">#&gt;  $ get_data    :function (data_object)  </span>
<span class="co">#&gt;  $ get_defaults:function (data_object, cache_object)</span></code></pre></div>
<p><code>shinyCohortBuilder</code> extends the filter attaching GUI-specific methods to it using <code>.gui_filter</code> S3 method. The methods are available at <code>filter$gui</code> object.</p>
<p>So, in order to implement custom filter controller we need to create <code>.gui_filter.&lt;filter-type&gt;</code> function.</p>
<p>The method takes filter (evaluated on source) as its argument and should return a list of the below objects:</p>
<ul>
<li>
<code>input</code> - UI structure defining filter input controllers.</li>
<li>
<code>feedback</code> - List defining feedback plot output.</li>
<li>
<code>server</code> - Optional server-side expression attached to filter panel (e.g. filter specific observers).</li>
<li>
<code>update</code> - An expression used for updating filter panel based on its configuration.</li>
<li>
<code>post_stats</code> - TRUE if post statistics are displayed in filter controller (e.g. for discrete filter). If FALSE, some operations are skipped which results with better performance.</li>
<li>
<code>multi_input</code> - TRUE if multiple input controllers are used for providing filter value (e.g. range input where both numericInput and sliderInput are used). If FALSE, some operations are skipped which results with better performance.</li>
</ul>
<p>Below we describe requirements and exact role of each object. We will base the description using “discrete” filter example.</p>
<div class="section level3">
<h3 id="input">input<a class="anchor" aria-label="anchor" href="#input"></a>
</h3>
<p><code>input</code> is the function returning the UI structure of filter input controllers (the content visible when filter is enrolled in filtering panel).</p>
<p>It takes two argument:</p>
<ul>
<li>
<code>input_id</code> - Concatenation of step_id and filter_id (plus namespace). Can be used as an input controller id (but doesn’t have to).</li>
<li>
<code>cohort</code> - The Cohort object.</li>
</ul>
<p>Example of implementation (simplified version used for “discrete” filter):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.gui_filter.discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filter</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    input <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_id</span>, <span class="va">cohort</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tagList.html" class="external-link">tagList</a></span><span class="op">(</span>
        <span class="fu"><a href="../reference/dot-cb_input.html">.cb_input</a></span><span class="op">(</span>
          <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>
            <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/shiny/man/checkboxGroupInput.html" class="external-link">checkboxGroupInput</a></span>,
            <span class="fu">discrete_input_params</span><span class="op">(</span><span class="va">filter</span>, <span class="va">input_id</span>, <span class="va">cohort</span>, <span class="va">...</span><span class="op">)</span>
          <span class="op">)</span>,
          <span class="va">filter</span><span class="op">$</span><span class="va">input_param</span>
        <span class="op">)</span>,
        <span class="fu"><a href="../reference/dot-cb_input.html">.cb_input</a></span><span class="op">(</span>
          <span class="fu">keep_na_input</span><span class="op">(</span><span class="va">input_id</span>, <span class="va">filter</span>, <span class="va">cohort</span><span class="op">)</span>,
          <span class="st">"keep_na"</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span>,
    <span class="co"># other objects</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>What we can realize, based on the construction, is that inside of the <code>input</code> function we can use not only its arguments but also <code>filter</code> object from the parent environment. This way we can access all the methods and metadata originally attached to the filter (i.e. its parameters via <code>filter$get_params()</code>).</p>
<p>As we can see the function returns a list (<code>tagList</code>) of two input controllers:</p>
<ul>
<li>
<code>checkboxGroupInput</code> - responsible for setting up filter value,</li>
<li>
<code>keep_na_input</code> - helper function returning a checkbox responsible for inclusion/exclusion of NA values (value of <code>keep_na</code> filter argument).</li>
</ul>
<p>The more important both input controllers are wrapped into <code>.cb_input</code> function.</p>
<p>Let’s first describe to meaning of <code>.cb_input</code>.</p>
<p>The function is responsible for registering any changes in input controller and updating the corresponding filter argument (with the value of controller). You may spot, we pass <code>filter$input_param</code> and <code>"keep_na"</code> as the second argument of <code>.cb_input</code> for <code>checkboxGroupInput</code> and <code>keep_na_input</code> respectively. The second argument informs <code>shinyCohortBuilder</code> via <code>.cb_input</code> which argument exactly should be updated in filter while changing the controller input.</p>
<p>This is the reason why do we keep the name of filter parameter responsible for data filtering (<code>input_param</code>) inside of the <code>cohortBuilder</code>’s filter (the name may differ for various filter types i.e. “value” for discrete filter, “range” for range filter).</p>
<p>The second effect of <code>.cb_input</code> is that input controllers wrapped into the function are sensitive only browser-site actions. That means filter arguments are updated only when user changes its value in the filtering panel - updating the input from server with <code>update*</code> function will affect only the controller visually.</p>
<p>Such effect is taken to assure no unneeded reactivity triggers are run. To make it more clear let’s consider a situation where filter panel consists of one discrete filter and we display post statistics nearby each checkbox option.</p>
<p><img src="02.png"></p>
<p>When changing selection in the filter we:</p>
<ol style="list-style-type: decimal">
<li>Update the filter value in Cohort.</li>
<li>Trigger data calculations.</li>
<li>Update post statistics for the filter in Cohort.</li>
<li>Update input controller choices having new statistics included.</li>
</ol>
<p>The last step is taken by using <code>update*</code> function, what triggers <code>shiny:inputchanged</code> JS event that <code>shinyCohortBuilder</code> uses for updating filter arguments. Such behavior results with another round of the above steps what could end up with having reactivity loop. Using <code>.cb_input</code> assures <code>shiny:inputchanged</code> JS event doesn’t trigger another filter parameters update when called using <code>update*</code> method.</p>
<p>Let’s move now to describe further assumptions while writing custom <code>input</code> method for <code>.gui_filter</code>.</p>
<p>Looking at the below code sample:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>
  <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/shiny/man/checkboxGroupInput.html" class="external-link">checkboxGroupInput</a></span>,
  <span class="fu">discrete_input_params</span><span class="op">(</span><span class="va">filter</span>, <span class="va">input_id</span>, <span class="va">cohort</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We can see internal function <code>discrete_input_params</code> is used to create a list of parameters sent to <code><a href="https://rdrr.io/pkg/shiny/man/checkboxGroupInput.html" class="external-link">shiny::checkboxGroupInput</a></code>.</p>
<p>While writing the function you should take into consideration the below assumptions:</p>
<ol style="list-style-type: decimal">
<li>When no data exists in the previous step the parameters should return an empty input controller.</li>
</ol>
<p>For discrete filter (<code>checkboxGroupInput</code>) we achieve this with:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">cohort</span><span class="op">$</span><span class="fu">get_cache</span><span class="op">(</span><span class="va">step_id</span>, <span class="va">filter_id</span>, state <span class="op">=</span> <span class="st">"pre"</span><span class="op">)</span><span class="op">$</span><span class="va">n_data</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inputId <span class="op">=</span> <span class="va">input_id</span>, choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, selected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, label <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>where:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">step_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">step_id</span>
<span class="va">filter_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">id</span></code></pre></div>
<p>It’s recommended to use cached statistics saved in the Cohort object to minimize the amount of operations. All the cached information for the specific filter are computed with <code>get_stats</code> filter method.</p>
<p>In case of discrete filter (for “tblist” source data type) it computes:</p>
<ul>
<li>
<code>choices</code> - named list storing counts for each variable level,</li>
<li>
<code>n_data</code> - integer storing number of non-missing values,</li>
<li>
<code>n_missing</code> - integer storing number of <code>NA</code>s</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>When filter value is NA, the controller should select all the available options (or range).</li>
</ol>
<p>You may get the current filter parameters with:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter_params</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="fu">get_params</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>and value with:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter_params</span><span class="op">[[</span><span class="va">filter</span><span class="op">$</span><span class="va">input_param</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<p>Extracting all the possible options can be done with:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span>
  <span class="va">cohort</span><span class="op">$</span><span class="fu">get_cache</span><span class="op">(</span><span class="va">step_id</span>, <span class="va">filter_id</span>, state <span class="op">=</span> <span class="st">"pre"</span><span class="op">)</span><span class="op">$</span><span class="va">choices</span>  
<span class="op">)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Filter controller choices should be based on the previous step.</li>
</ol>
<p>This can be easily extracted using previous step cache:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span>
  <span class="va">cohort</span><span class="op">$</span><span class="fu">get_cache</span><span class="op">(</span><span class="va">step_id</span>, <span class="va">filter_id</span>, state <span class="op">=</span> <span class="st">"pre"</span><span class="op">)</span><span class="op">$</span><span class="va">choices</span>  
<span class="op">)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>When <a href="shinyCohortBuilder.html#filter-vs-filter-controller">value mapping</a> is defined for the filter it should be used to convert choices labels accordingly.</li>
</ol>
<p>You can check is value mapping is defined with:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">filter_params</span><span class="op">$</span><span class="va">value_mapping</span><span class="op">)</span></code></pre></div>
<p>and access the value mapping function with:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span><span class="op">$</span><span class="fu">get_source</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">attributes</span><span class="op">$</span><span class="va">value_mappings</span><span class="op">[[</span><span class="va">filter_params</span><span class="op">$</span><span class="va">value_mapping</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>When the filters displays pre/post statistics (i.e. discrete filter does) you should assure the ones are included in according filter labels.</li>
</ol>
<p>For this case you may use a helper <code>.choice_names</code> function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.choice_names</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="sc">&lt;</span>choices labels names vector<span class="sc">&gt;</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">current =</span> <span class="sc">&lt;</span>current step statistics vector<span class="sc">&gt;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">previous =</span> <span class="sc">&lt;</span>previous step statistics vector<span class="sc">&gt;</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stats =</span> <span class="sc">&lt;</span><span class="st">"pre, post"</span>, both or <span class="cn">NULL</span><span class="sc">&gt;</span> <span class="co"># it's recommended to use `stats = cohort$attributes$stats` to inherit the option from Cohort configuration</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>which returns labels with the selected statistics and brackets added.</p>
<p>The function returns labels in an HTML structure attaching proper classes to the current step labels. Such (HTML) class is used to grey out the label when working with <code>Run Button</code> feature.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">.choice_names</span><span class="op">(</span>
  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,
  current <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,
  previous <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">4</span>,
  stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pre"</span>, <span class="st">"post"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; &lt;span&gt;A (&lt;span class = 'cb_delayed'&gt;1&lt;/span&gt; / 3)&lt;/span&gt;</span>
<span class="co">#&gt; &lt;span&gt;B (&lt;span class = 'cb_delayed'&gt;2&lt;/span&gt; / 4)&lt;/span&gt;</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>The filter controller should not have any label attached.</li>
</ol>
<p>For <code>checkboxGroupInput</code> (and most of shiny controllers) this can be achieved with <code>label = NULL</code>.</p>
</div>
<div class="section level3">
<h3 id="feedback">feedback<a class="anchor" aria-label="anchor" href="#feedback"></a>
</h3>
<p><code>input</code> is the function returning the UI structure of filter input controllers (the content visible when filter is enrolled in filtering panel).</p>
<p>It takes two argument:</p>
<ul>
<li>
<code>input_id</code> - Concatenation of step_id and filter_id (plus namespace). Can be used as an input controller id (but doesn’t have to).</li>
<li>
<code>cohort</code> - The Cohort object.</li>
<li>
<code>empty</code> - FALSE by default. When NULL (feedback plot are turned off) feedback should return no value. When TRUE (no valid data exists in the previous filtering step, i.e. number of rows is zero) an empty plot should be returned (preferable with very small height).</li>
</ul>
<p>The function should return list of three objects:</p>
<ul>
<li>
<code>plot_id</code> - id of feedback plot output (preferably modification of <code>input_id</code> including namespace),</li>
<li>
<code>output_fun</code> - plot output UI placeholder function,</li>
<li>
<code>render_fun</code> - plot output rendering logic (excluding output assignment).</li>
</ul>
<p>Example of implementation (simplified version used for “discrete” filter):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.gui_filter.discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filter</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    feedback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_id</span>, <span class="va">cohort</span>, <span class="va">empty</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
        plot_id <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS</a></span><span class="op">(</span><span class="va">input_id</span>, <span class="st">"feedback_plot"</span><span class="op">)</span> ,
        output_fun <span class="op">=</span> <span class="fu">ggiraph</span><span class="fu">::</span><span class="va"><a href="https://davidgohel.github.io/ggiraph/reference/girafeOutput.html" class="external-link">girafeOutput</a></span>,
        render_fun <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">empty</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu">ggiraph</span><span class="fu">::</span><span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/renderGirafe.html" class="external-link">renderGirafe</a></span><span class="op">(</span><span class="op">{</span>
            <span class="kw">if</span><span class="op">(</span><span class="va">empty</span><span class="op">)</span> <span class="op">{</span> <span class="co"># when no data in parent step</span>
              <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span>
                <span class="fu">ggiraph</span><span class="fu">::</span><span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/girafe.html" class="external-link">girafe</a></span><span class="op">(</span>
                  ggobj      <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span>,
                  width_svg  <span class="op">=</span> <span class="fl">10</span>,
                  height_svg <span class="op">=</span> <span class="fl">0.1</span>
                <span class="op">)</span>
              <span class="op">)</span>
            <span class="op">}</span>
            <span class="va">step_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">step_id</span>
            <span class="va">filter_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">id</span>

            <span class="va">filter_cache</span> <span class="op">&lt;-</span> <span class="va">cohort</span><span class="op">$</span><span class="fu">get_cache</span><span class="op">(</span><span class="va">step_id</span>, <span class="va">filter_id</span>, state <span class="op">=</span> <span class="st">"pre"</span><span class="op">)</span>
            <span class="va">filter_value</span> <span class="op">&lt;-</span> <span class="fu">extract_selected_value</span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="fu">get_params</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>, <span class="va">filter_cache</span><span class="op">$</span><span class="va">choices</span>, <span class="cn">FALSE</span><span class="op">)</span>
            <span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">filter_cache</span><span class="op">$</span><span class="va">choices</span><span class="op">[</span><span class="va">filter_value</span><span class="op">]</span>
            <span class="va">n_missing</span> <span class="op">&lt;-</span> <span class="va">filter_cache</span><span class="op">$</span><span class="va">n_missing</span>
            <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="fu">get_params</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">keep_na</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
              <span class="va">n_missing</span> <span class="op">&lt;-</span> <span class="fl">0</span>
            <span class="op">}</span>

            <span class="fu">plot_feedback_bar</span><span class="op">(</span><span class="va">plot_data</span>, <span class="va">n_missing</span><span class="op">)</span>
          <span class="op">}</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">)</span>
    <span class="op">}</span>,
    <span class="co"># other methods</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Details:</p>
<ul>
<li>
<code>render_fun</code> should be wrapped within <code>if (!is.null(empty)) {}</code> if claim.</li>
<li>Inside the rendering function body, return an empty plot when <code>empty = TRUE</code>.</li>
<li>It’s recommended to generate plot based on cached Cohort statistics. The filter cache can be accessed with: <code>cohort$get_cache(step_id, filter_id, state = "pre")</code>, where:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">step_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">step_id</span>
<span class="va">filter_id</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">id</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server">server<a class="anchor" aria-label="anchor" href="#server"></a>
</h3>
<p>This is an optional method providing extra logic to filter controller in the application server. The function is called only once when filter controller is rendered.</p>
<p>In case of discrete filter, the function is used to extend logic for feedback plot. Whenever a field related to specific value is clicked on the plot it result with selecting the value in input controller.</p>
<p>So we define there an observer, that listens to plot click action and triggers accordingly “update_filter” action:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.gui_filter.discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filter</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    server <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_id</span>, <span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span>, <span class="va">cohort</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">[[</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS</a></span><span class="op">(</span><span class="va">input_id</span>, <span class="st">"feedback_plot_selected"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>, <span class="op">{</span>
        <span class="va">value</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">[[</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS</a></span><span class="op">(</span><span class="va">input_id</span>, <span class="st">"feedback_plot_selected"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>

        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu"><a href="../reference/trigger-action.html">.trigger_action</a></span><span class="op">(</span><span class="va">session</span>, <span class="st">"update_filter"</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
            step_id <span class="op">=</span> <span class="va">filter</span><span class="op">$</span><span class="va">step_id</span>, filter_id <span class="op">=</span> <span class="va">filter</span><span class="op">$</span><span class="va">id</span>,
            input_name <span class="op">=</span> <span class="va">filter</span><span class="op">$</span><span class="va">input_param</span>, input_value <span class="op">=</span> <span class="va">value</span>,
            run_flow <span class="op">=</span> <span class="cn">FALSE</span>
          <span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>, ignoreInit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/dot-save_observer.html">.save_observer</a></span><span class="op">(</span><span class="va">input_id</span>, <span class="va">session</span><span class="op">)</span>
    <span class="op">}</span>,
    <span class="co"># other methods</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>You may spot here a usage of <code>.save_observer</code>, to which the observer is passed. The method is used to save the observer in application memory, so that the observer is destroyed whenever the filter is removed.</p>
<p>The action is taken to prevent observers <a href="https://appsilon.com/how-to-safely-remove-a-dynamic-shiny-module/" class="external-link">accumulation</a>.</p>
</div>
<div class="section level3">
<h3 id="update">update<a class="anchor" aria-label="anchor" href="#update"></a>
</h3>
<p><code>update</code> is the function defining how filter input controllers should be updated based on the previous and current step data.</p>
<p>The method is called in the below scenarios:</p>
<ul>
<li>when previous filtering step was modified,</li>
<li>when filter displays post statistics (i.e. discrete filer) and the current data changed (for example by making any changes in the current step),</li>
<li>when filter GUI panel is using multiple input controllers and one of them has changed,</li>
<li>when “Clear Step” button is pressed,</li>
<li>when <code>update_filter</code> action was triggered directly (advanced case)</li>
</ul>
<p><code>update</code> function is strongly related to the <code>input</code> one. The parameters passed to related <code>update*</code> methods should follow the same assumptions as stated for <code>input</code>. More to that there is one extra rule regarding “Clear Step” scenario which we describe below.</p>
<p>The update function should have the below parameters defined:</p>
<ul>
<li>
<code>session</code> - Shiny session object passed to <code>update*</code> methods.</li>
<li>
<code>input_id</code> - The same ID as passed to <code>input</code>.</li>
<li>
<code>cohort</code> - Cohort object.</li>
<li>
<code>reset</code> - If TRUE, the <code>update</code> method is called due to click of “Clear Step” button.</li>
</ul>
<p>Below we present the sample of <code>update</code> method used for discrete filter:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.gui_filter.discrete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filter</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    update <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">session</span>, <span class="va">input_id</span>, <span class="va">cohort</span>, <span class="va">reset</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">update_params</span> <span class="op">&lt;-</span> <span class="fu">discrete_input_params</span><span class="op">(</span><span class="va">filter</span>, <span class="va">input_id</span>, <span class="va">cohort</span>, reset <span class="op">=</span> <span class="va">reset</span>, update <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>
        <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/shiny/man/updateCheckboxGroupInput.html" class="external-link">updateCheckboxGroupInput</a></span>,
        <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span>
          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>session <span class="op">=</span> <span class="va">session</span><span class="op">)</span>,
          <span class="va">update_params</span>
        <span class="op">)</span>
      <span class="op">)</span>
      <span class="fu">.update_keep_na_input</span><span class="op">(</span><span class="va">session</span>, <span class="va">input_id</span>, <span class="va">filter</span>, <span class="va">cohort</span><span class="op">)</span>
    <span class="op">}</span>,
    <span class="co"># other methods</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>As you can see, we reuse <code>discrete_input_params</code> function for generating the parameters, with two extra arguments passed to it:</p>
<ul>
<li>
<code>reset</code> - the information that states “Clear Step” was clicked,</li>
<li>
<code>update</code> - an indicator that states we generate parameters for <code>update</code> method.</li>
</ul>
<p>Now let’s highlight how <code>reset</code> and <code>update</code> argument affect the returned parameters:</p>
<ol style="list-style-type: decimal">
<li>When <code>reset = TRUE</code> controller should select all the available options (or range).</li>
</ol>
<p>Again, all the possible options can be extracted with:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span>
  <span class="va">cohort</span><span class="op">$</span><span class="fu">get_cache</span><span class="op">(</span><span class="va">step_id</span>, <span class="va">filter_id</span>, state <span class="op">=</span> <span class="st">"pre"</span><span class="op">)</span><span class="op">$</span><span class="va">choices</span>  
<span class="op">)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>When <code>update = TRUE</code> the filter controller label should be cleared.</li>
</ol>
<p>There is a small difference comparing to case when label is defined for initializing the controller. In the case <code>label = NULL</code> but for <code>update</code> the valid value id <code>label = character(0)</code>.</p>
<p>So we only need to add:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">label</span> <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">update</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="kw">else</span> <span class="cn">NULL</span></code></pre></div>
<p>Looking at the code sample for <code>update</code> above we may realize, the usage of <code>.update_keep_na_input</code>. You can use the function whenever you use <code>.keep_na_input</code> in <code>input</code> function.</p>
</div>
<div class="section level3">
<h3 id="post_stats">post_stats<a class="anchor" aria-label="anchor" href="#post_stats"></a>
</h3>
<p>Static logical value informing whether the filter can display post statistics. When TRUE, the filter will be updated (using attached <code>update</code> method) whenever any other filter is changed (to assure up to date value of post statistic).</p>
</div>
<div class="section level3">
<h3 id="multi_input">multi_input<a class="anchor" aria-label="anchor" href="#multi_input"></a>
</h3>
<p>Logical value informing whether the filter GUI panel uses multiple input controllers to specify the filter value (range filter case when both slider and numeric input are used). When TRUE, <code>shinyCohortBuilder</code> will be informed to update input controller whenever the other one changes.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Krystian Igras, Kamil Wais.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
